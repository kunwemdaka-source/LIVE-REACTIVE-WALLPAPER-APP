<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Wallpaper - Wallpaper Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.2.4/pixi.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --color-primary: #1a1a1a;
            --color-secondary: #faf9f6;
            --color-accent: #9caf88;
            --color-warm: #d4a5a5;
            --color-graphite: #2d2d2d;
            --color-pearl: #f8f8f8;
            --color-eucalyptus: #7a9471;
            --color-blush: #e8c4c4;
            --font-body: 'Inter', sans-serif;
            --font-mono: 'Space Mono', monospace;
            --spacing-unit: 8px;
            --border-radius: 12px;
            --shadow-soft: 0 4px 24px rgba(0,0,0,0.1);
            --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: var(--color-primary);
            color: var(--color-secondary);
            overflow-x: hidden;
            line-height: 1.6;
        }

        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(156, 175, 136, 0.2);
            padding: 16px 0;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-family: var(--font-mono);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-accent);
            letter-spacing: -0.02em;
            cursor: pointer;
        }

        .nav-links {
            display: flex;
            gap: 32px;
            list-style: none;
        }

        .nav-links a {
            color: var(--color-secondary);
            text-decoration: none;
            font-weight: 400;
            font-size: 0.9rem;
            transition: color 0.3s var(--transition-smooth);
            position: relative;
        }

        .nav-links a:hover, .nav-links a.active {
            color: var(--color-accent);
        }

        .main-content {
            padding: 100px 0 40px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
        }

        .workspace {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 32px;
            height: calc(100vh - 140px);
        }

        .canvas-area {
            background: var(--color-graphite);
            border-radius: var(--border-radius);
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-soft);
        }

        .editor-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .canvas-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 12px;
        }

        .canvas-btn {
            width: 40px;
            height: 40px;
            background: rgba(26, 26, 26, 0.8);
            border: none;
            border-radius: 50%;
            color: var(--color-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s var(--transition-smooth);
            backdrop-filter: blur(10px);
        }

        .canvas-btn:hover {
            background: var(--color-accent);
            color: var(--color-primary);
            transform: scale(1.1);
        }

        .controls-panel {
            background: rgba(248, 248, 248, 0.02);
            border-radius: var(--border-radius);
            border: 1px solid rgba(156, 175, 136, 0.1);
            overflow-y: auto;
        }

        .panel-header {
            padding: 24px;
            border-bottom: 1px solid rgba(156, 175, 136, 0.1);
        }

        .panel-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .panel-subtitle {
            font-size: 0.9rem;
            color: var(--color-graphite);
        }

        .tool-section {
            padding: 24px;
            border-bottom: 1px solid rgba(156, 175, 136, 0.1);
        }

        .tool-section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .tool-card {
            background: var(--color-graphite);
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s var(--transition-smooth);
            text-align: center;
            border: 2px solid transparent;
        }

        .tool-card:hover {
            transform: translateY(-2px);
            border-color: var(--color-accent);
        }

        .tool-card.active {
            border-color: var(--color-accent);
            background: var(--color-accent);
            color: var(--color-primary);
        }

        .tool-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
            display: block;
        }

        .tool-name {
            font-size: 0.8rem;
            font-weight: 500;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .control-value {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--color-accent);
        }

        .slider {
            width: 100%;
            height: 6px;
            background: rgba(156, 175, 136, 0.2);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--color-accent);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s var(--transition-smooth);
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 0 8px rgba(156, 175, 136, 0.2);
        }

        .color-harmony {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .harmony-color {
            aspect-ratio: 1;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s var(--transition-smooth);
        }

        .harmony-color:hover {
            transform: scale(1.1);
            border-color: var(--color-secondary);
        }

        .harmony-color.active {
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px rgba(156, 175, 136, 0.3);
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .preset-item {
            aspect-ratio: 1;
            background: var(--color-graphite);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s var(--transition-smooth);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 500;
            border: 2px solid transparent;
        }

        .preset-item:hover {
            transform: scale(1.05);
            border-color: var(--color-accent);
        }

        .preset-item.active {
            border-color: var(--color-accent);
            background: var(--color-accent);
            color: var(--color-primary);
        }

        .action-buttons {
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s var(--transition-smooth);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--color-accent);
            color: var(--color-primary);
        }

        .btn-primary:hover {
            background: var(--color-eucalyptus);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(156, 175, 136, 0.3);
        }

        .btn-secondary {
            background: var(--color-graphite);
            color: var(--color-secondary);
            border: 1px solid rgba(156, 175, 136, 0.3);
        }

        .btn-secondary:hover {
            background: var(--color-eucalyptus);
            border-color: var(--color-eucalyptus);
        }

        .btn-outline {
            background: transparent;
            color: var(--color-accent);
            border: 2px solid var(--color-accent);
        }

        .btn-outline:hover {
            background: var(--color-accent);
            color: var(--color-primary);
        }

        .mobile-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: var(--color-accent);
            border: none;
            border-radius: 50%;
            color: var(--color-primary);
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(156, 175, 136, 0.3);
            z-index: 40;
            transition: all 0.3s var(--transition-smooth);
        }

        .mobile-toggle:hover {
            transform: scale(1.1);
        }

        .notification {
            position: fixed;
            top: 100px;
            right: 24px;
            padding: 16px 24px;
            background: var(--color-accent);
            color: var(--color-primary);
            border-radius: var(--border-radius);
            font-weight: 500;
            z-index: 60;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s var(--transition-smooth);
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        @media (max-width: 1024px) {
            .workspace {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .controls-panel {
                position: fixed;
                top: 80px;
                right: -100%;
                width: 100%;
                height: calc(100vh - 80px);
                z-index: 30;
                transition: right 0.3s var(--transition-smooth);
            }
            
            .controls-panel.active {
                right: 0;
            }
            
            .mobile-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .canvas-area {
                height: 60vh;
                min-height: 400px;
            }
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 26, 26, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s var(--transition-smooth);
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(156, 175, 136, 0.3);
            border-top-color: var(--color-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo" onclick="window.location.href='index.html'">WALLPAPER STUDIO</div>
            <ul class="nav-links">
                <li><a href="index.html">Gallery</a></li>
                <li><a href="customize.html">Customize</a></li>
                <li><a href="editor.html" class="active">Create</a></li>
                <li><a href="index.html#collections">Collections</a></li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <div class="workspace">
                <div class="canvas-area">
                    <div id="editorCanvas" class="editor-canvas"></div>
                    <div class="canvas-overlay">
                        <button class="canvas-btn" id="playPauseBtn" title="Play/Pause Animation">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1.586a1 1 0 01.707.293l2.414 2.414a1 1 0 00.707.293H15M9 10V9a2 2 0 012-2h2a2 2 0 012 2v1M9 10v5a2 2 0 002 2h2a2 2 0 002-2v-5"></path>
                            </svg>
                        </button>
                        <button class="canvas-btn" id="fullscreenBtn" title="Fullscreen">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                            </svg>
                        </button>
                        <button class="canvas-btn" id="resetBtn" title="Reset">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="loading-overlay" id="loadingOverlay">
                        <div class="spinner"></div>
                    </div>
                </div>

                <div class="controls-panel" id="controlsPanel">
                    <div class="panel-header">
                        <h2 class="panel-title">Create Wallpaper</h2>
                        <p class="panel-subtitle">Generate custom abstract art with interactive tools</p>
                    </div>

                    <div class="tool-section">
                        <div class="section-title">Generation Tools</div>
                        <div class="tool-grid">
                            <div class="tool-card active" data-tool="particles">
                                <span class="tool-icon">‚ú®</span>
                                <span class="tool-name">Particles</span>
                            </div>
                            <div class="tool-card" data-tool="waves">
                                <span class="tool-icon">üåä</span>
                                <span class="tool-name">Waves</span>
                            </div>
                            <div class="tool-card" data-tool="fractals">
                                <span class="tool-icon">‚ùÑÔ∏è</span>
                                <span class="tool-name">Fractals</span>
                            </div>
                            <div class="tool-card" data-tool="noise">
                                <span class="tool-icon">üå´Ô∏è</span>
                                <span class="tool-name">Noise</span>
                            </div>
                            <div class="tool-card" data-tool="geometric">
                                <span class="tool-icon">üî∑</span>
                                <span class="tool-name">Geometric</span>
                            </div>
                            <div class="tool-card" data-tool="flow">
                                <span class="tool-icon">üåÄ</span>
                                <span class="tool-name">Flow Field</span>
                            </div>
                        </div>
                    </div>

                    <div class="tool-section">
                        <div class="section-title">Color Harmony</div>
                        <div class="color-harmony" id="colorHarmony">
                            <div class="harmony-color active" data-color="#9caf88" style="background: #9caf88;"></div>
                            <div class="harmony-color" data-color="#d4a5a5" style="background: #d4a5a5;"></div>
                            <div class="harmony-color" data-color="#7a9471" style="background: #7a9471;"></div>
                            <div class="harmony-color" data-color="#e8c4c4" style="background: #e8c4c4;"></div>
                            <div class="harmony-color" data-color="#2d2d2d" style="background: #2d2d2d;"></div>
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">
                                <span>Color Variation</span>
                                <span class="control-value" id="colorVariationValue">50%</span>
                            </div>
                            <input type="range" class="slider" id="colorVariationSlider" min="0" max="100" value="50">
                        </div>
                    </div>

                    <div class="tool-section">
                        <div class="section-title">Pattern Controls</div>
                        
                        <div class="control-group">
                            <div class="control-label">
                                <span>Complexity</span>
                                <span class="control-value" id="complexityValue">5</span>
                            </div>
                            <input type="range" class="slider" id="complexitySlider" min="1" max="10" value="5">
                        </div>

                        <div class="control-group">
                            <div class="control-label">
                                <span>Scale</span>
                                <span class="control-value" id="scaleValue">1.0x</span>
                            </div>
                            <input type="range" class="slider" id="scaleSlider" min="0.1" max="3" step="0.1" value="1">
                        </div>

                        <div class="control-group">
                            <div class="control-label">
                                <span>Speed</span>
                                <span class="control-value" id="speedValue">1.0x</span>
                            </div>
                            <input type="range" class="slider" id="speedSlider" min="0" max="3" step="0.1" value="1">
                        </div>

                        <div class="control-group">
                            <div class="control-label">
                                <span>Density</span>
                                <span class="control-value" id="densityValue">100</span>
                            </div>
                            <input type="range" class="slider" id="densitySlider" min="10" max="500" value="100">
                        </div>
                    </div>

                    <div class="tool-section">
                        <div class="section-title">Presets</div>
                        <div class="preset-grid" id="presetGrid">
                            <div class="preset-item active" data-preset="calm">Calm</div>
                            <div class="preset-item" data-preset="energetic">Energy</div>
                            <div class="preset-item" data-preset="minimal">Minimal</div>
                            <div class="preset-item" data-preset="complex">Complex</div>
                            <div class="preset-item" data-preset="organic">Organic</div>
                            <div class="preset-item" data-preset="geometric">Geometric</div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-primary" id="generateBtn">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Generate New
                        </button>
                        <button class="btn btn-secondary" id="randomizeBtn">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1.586a1 1 0 01.707.293l2.414 2.414a1 1 0 00.707.293H15M9 10V9a2 2 0 012-2h2a2 2 0 012 2v1M9 10v5a2 2 0 002 2h2a2 2 0 002-2v-5"></path>
                            </svg>
                            Randomize
                        </button>
                        <button class="btn btn-outline" id="exportBtn">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Export
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <button class="mobile-toggle" id="mobileToggle">
        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
        </svg>
    </button>

    <div class="notification" id="notification"></div>

    <script>
        class WallpaperEditor {
            constructor() {
                this.canvas = null;
                this.currentTool = 'particles';
                this.isAnimating = true;
                this.settings = {
                    color: '#9caf88',
                    colorVariation: 50,
                    complexity: 5,
                    scale: 1.0,
                    speed: 1.0,
                    density: 100
                };
                this.particles = [];
                this.time = 0;
                this.init();
            }

            init() {
                this.setupCanvas();
                this.setupEventListeners();
                this.generatePattern();
            }

            setupCanvas() {
                if (typeof p5 !== 'undefined') {
                    new p5((p) => {
                        this.p5Instance = p;
                        
                        p.setup = () => {
                            const canvas = p.createCanvas(1920, 1080);
                            canvas.parent('editorCanvas');
                            canvas.style('max-width', '100%');
                            canvas.style('max-height', '100%');
                            canvas.style('width', 'auto');
                            canvas.style('height', 'auto');
                            canvas.style('object-fit', 'contain');
                            
                            this.canvas = canvas;
                            this.initializePattern();
                        };

                        p.draw = () => {
                            if (this.isAnimating) {
                                this.time += 0.01 * this.settings.speed;
                                this.updatePattern();
                                this.renderPattern();
                            }
                        };

                        p.windowResized = () => {
                            // Maintain aspect ratio on resize
                            const container = document.getElementById('editorCanvas');
                            const rect = container.getBoundingClientRect();
                            p.resizeCanvas(rect.width, rect.height);
                        };
                    });
                }
            }

            setupEventListeners() {
                // Tool selection
                document.querySelectorAll('.tool-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        document.querySelectorAll('.tool-card').forEach(c => c.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        this.currentTool = e.currentTarget.dataset.tool;
                        this.generatePattern();
                    });
                });

                // Color harmony
                document.querySelectorAll('.harmony-color').forEach(color => {
                    color.addEventListener('click', (e) => {
                        document.querySelectorAll('.harmony-color').forEach(c => c.classList.remove('active'));
                        e.target.classList.add('active');
                        this.settings.color = e.target.dataset.color;
                        this.generatePattern();
                    });
                });

                // Controls
                const controls = [
                    { id: 'colorVariationSlider', key: 'colorVariation', valueId: 'colorVariationValue', suffix: '%' },
                    { id: 'complexitySlider', key: 'complexity', valueId: 'complexityValue', suffix: '' },
                    { id: 'scaleSlider', key: 'scale', valueId: 'scaleValue', suffix: 'x' },
                    { id: 'speedSlider', key: 'speed', valueId: 'speedValue', suffix: 'x' },
                    { id: 'densitySlider', key: 'density', valueId: 'densityValue', suffix: '' }
                ];

                controls.forEach(control => {
                    const slider = document.getElementById(control.id);
                    const valueDisplay = document.getElementById(control.valueId);
                    
                    slider.addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        this.settings[control.key] = value;
                        valueDisplay.textContent = value + control.suffix;
                        this.generatePattern();
                    });
                });

                // Presets
                document.querySelectorAll('.preset-item').forEach(preset => {
                    preset.addEventListener('click', (e) => {
                        document.querySelectorAll('.preset-item').forEach(p => p.classList.remove('active'));
                        e.target.classList.add('active');
                        this.applyPreset(e.target.dataset.preset);
                    });
                });

                // Action buttons
                document.getElementById('generateBtn').addEventListener('click', () => {
                    this.generatePattern();
                    this.showNotification('New pattern generated!');
                });

                document.getElementById('randomizeBtn').addEventListener('click', () => {
                    this.randomizeSettings();
                    this.generatePattern();
                    this.showNotification('Settings randomized!');
                });

                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportWallpaper();
                });

                document.getElementById('playPauseBtn').addEventListener('click', () => {
                    this.toggleAnimation();
                });

                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.resetToDefaults();
                    this.generatePattern();
                    this.showNotification('Reset to defaults');
                });

                document.getElementById('fullscreenBtn').addEventListener('click', () => {
                    this.toggleFullscreen();
                });

                // Mobile toggle
                document.getElementById('mobileToggle').addEventListener('click', () => {
                    document.getElementById('controlsPanel').classList.toggle('active');
                });
            }

            initializePattern() {
                this.particles = [];
                for (let i = 0; i < this.settings.density; i++) {
                    this.particles.push({
                        x: this.p5Instance.random(this.p5Instance.width),
                        y: this.p5Instance.random(this.p5Instance.height),
                        vx: this.p5Instance.random(-1, 1),
                        vy: this.p5Instance.random(-1, 1),
                        size: this.p5Instance.random(2, 8),
                        color: this.p5Instance.color(this.settings.color)
                    });
                }
            }

            generatePattern() {
                this.p5Instance.clear();
                this.initializePattern();
                this.renderPattern();
            }

            updatePattern() {
                const p = this.p5Instance;
                
                switch (this.currentTool) {
                    case 'particles':
                        this.updateParticles();
                        break;
                    case 'waves':
                        this.updateWaves();
                        break;
                    case 'fractals':
                        this.updateFractals();
                        break;
                    case 'noise':
                        this.updateNoise();
                        break;
                    case 'geometric':
                        this.updateGeometric();
                        break;
                    case 'flow':
                        this.updateFlowField();
                        break;
                }
            }

            renderPattern() {
                const p = this.p5Instance;
                
                // Clear with subtle fade
                p.fill(26, 26, 26, 20);
                p.rect(0, 0, p.width, p.height);
                
                switch (this.currentTool) {
                    case 'particles':
                        this.renderParticles();
                        break;
                    case 'waves':
                        this.renderWaves();
                        break;
                    case 'fractals':
                        this.renderFractals();
                        break;
                    case 'noise':
                        this.renderNoise();
                        break;
                    case 'geometric':
                        this.renderGeometric();
                        break;
                    case 'flow':
                        this.renderFlowField();
                        break;
                }
            }

            updateParticles() {
                this.particles.forEach(particle => {
                    particle.x += particle.vx * this.settings.speed;
                    particle.y += particle.vy * this.settings.speed;
                    
                    // Wrap around edges
                    if (particle.x < 0) particle.x = this.p5Instance.width;
                    if (particle.x > this.p5Instance.width) particle.x = 0;
                    if (particle.y < 0) particle.y = this.p5Instance.height;
                    if (particle.y > this.p5Instance.height) particle.y = 0;
                    
                    // Add some noise
                    particle.vx += this.p5Instance.random(-0.1, 0.1);
                    particle.vy += this.p5Instance.random(-0.1, 0.1);
                });
            }

            renderParticles() {
                const p = this.p5Instance;
                
                this.particles.forEach(particle => {
                    p.fill(particle.color);
                    p.noStroke();
                    p.ellipse(particle.x, particle.y, particle.size * this.settings.scale);
                });
                
                // Connect nearby particles
                for (let i = 0; i < this.particles.length; i++) {
                    for (let j = i + 1; j < this.particles.length; j++) {
                        const dist = p.dist(this.particles[i].x, this.particles[i].y, 
                                          this.particles[j].x, this.particles[j].y);
                        if (dist < 100 * this.settings.scale) {
                            const alpha = p.map(dist, 0, 100 * this.settings.scale, 100, 0);
                            p.stroke(p.red(this.settings.color), p.green(this.settings.color), 
                                   p.blue(this.settings.color), alpha);
                            p.strokeWeight(1);
                            p.line(this.particles[i].x, this.particles[i].y, 
                                  this.particles[j].x, this.particles[j].y);
                        }
                    }
                }
            }

            updateWaves() {
                // Waves are time-based, no particle update needed
            }

            renderWaves() {
                const p = this.p5Instance;
                p.noFill();
                
                for (let i = 0; i < this.settings.complexity * 3; i++) {
                    p.stroke(p.color(this.settings.color));
                    p.strokeWeight(2);
                    p.beginShape();
                    for (let x = 0; x <= p.width; x += 10) {
                        const y = p.height/2 + p.sin((x + this.time * 50) * 0.01 + i * 0.5) * 50 * this.settings.scale;
                        p.vertex(x, y);
                    }
                    p.endShape();
                }
            }

            updateFractals() {
                // Fractals are static patterns
            }

            renderFractals() {
                const p = this.p5Instance;
                p.stroke(p.color(this.settings.color));
                p.strokeWeight(1);
                p.noFill();
                
                this.drawFractal(p.width/2, p.height/2, 100 * this.settings.scale, this.settings.complexity, 0);
            }

            drawFractal(x, y, size, depth, angle) {
                const p = this.p5Instance;
                
                if (depth === 0) return;
                
                p.push();
                p.translate(x, y);
                p.rotate(angle);
                
                p.line(0, 0, size, 0);
                
                this.drawFractal(size, 0, size * 0.7, depth - 1, p.PI/4);
                this.drawFractal(size, 0, size * 0.7, depth - 1, -p.PI/4);
                
                p.pop();
            }

            updateNoise() {
                // Noise field updates continuously
            }

            renderNoise() {
                const p = this.p5Instance;
                const scale = 0.01 * this.settings.scale;
                
                p.loadPixels();
                for (let x = 0; x < p.width; x += 2) {
                    for (let y = 0; y < p.height; y += 2) {
                        const noiseVal = p.noise(x * scale, y * scale, this.time);
                        const brightness = p.map(noiseVal, 0, 1, 0, 255);
                        
                        p.fill(p.color(this.settings.color));
                        p.noStroke();
                        p.rect(x, y, 2, 2);
                    }
                }
            }

            updateGeometric() {
                // Geometric patterns update based on time
            }

            renderGeometric() {
                const p = this.p5Instance;
                p.stroke(p.color(this.settings.color));
                p.strokeWeight(2);
                p.noFill();
                
                const gridSize = 50 * this.settings.scale;
                const offset = p.sin(this.time) * 20;
                
                for (let x = 0; x < p.width; x += gridSize) {
                    for (let y = 0; y < p.height; y += gridSize) {
                        const shapeType = p.floor((x + y) / gridSize) % this.settings.complexity;
                        
                        p.push();
                        p.translate(x + gridSize/2, y + gridSize/2);
                        p.rotate(this.time * 0.1);
                        
                        switch (shapeType) {
                            case 0:
                                p.ellipse(0, 0, gridSize * 0.8);
                                break;
                            case 1:
                                p.rect(-gridSize/3, -gridSize/3, gridSize * 0.6);
                                break;
                            case 2:
                                p.triangle(0, -gridSize/3, -gridSize/3, gridSize/3, gridSize/3, gridSize/3);
                                break;
                        }
                        p.pop();
                    }
                }
            }

            updateFlowField() {
                this.particles.forEach(particle => {
                    const angle = this.p5Instance.noise(
                        particle.x * 0.01, 
                        particle.y * 0.01, 
                        this.time * 0.1
                    ) * this.p5Instance.TWO_PI;
                    
                    particle.vx = p5.Vector.fromAngle(angle).x * this.settings.speed;
                    particle.vy = p5.Vector.fromAngle(angle).y * this.settings.speed;
                    
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    
                    // Wrap around edges
                    if (particle.x < 0) particle.x = this.p5Instance.width;
                    if (particle.x > this.p5Instance.width) particle.x = 0;
                    if (particle.y < 0) particle.y = this.p5Instance.height;
                    if (particle.y > this.p5Instance.height) particle.y = 0;
                });
            }

            renderFlowField() {
                const p = this.p5Instance;
                
                // Draw flow lines
                p.stroke(p.color(this.settings.color));
                p.strokeWeight(1);
                
                for (let x = 0; x < p.width; x += 20) {
                    for (let y = 0; y < p.height; y += 20) {
                        const angle = p.noise(x * 0.01, y * 0.01, this.time * 0.1) * p.TWO_PI;
                        const length = 15 * this.settings.scale;
                        
                        p.push();
                        p.translate(x, y);
                        p.rotate(angle);
                        p.line(0, 0, length, 0);
                        p.pop();
                    }
                }
                
                // Draw particles
                this.particles.forEach(particle => {
                    p.fill(particle.color);
                    p.noStroke();
                    p.ellipse(particle.x, particle.y, particle.size);
                });
            }

            applyPreset(presetName) {
                const presets = {
                    calm: { complexity: 3, scale: 0.8, speed: 0.5, density: 50 },
                    energetic: { complexity: 8, scale: 1.5, speed: 2.0, density: 200 },
                    minimal: { complexity: 2, scale: 0.6, speed: 0.3, density: 30 },
                    complex: { complexity: 10, scale: 1.2, speed: 1.0, density: 300 },
                    organic: { complexity: 6, scale: 1.0, speed: 0.8, density: 150 },
                    geometric: { complexity: 7, scale: 1.3, speed: 0.6, density: 100 }
                };

                const preset = presets[presetName];
                if (preset) {
                    this.settings = { ...this.settings, ...preset };
                    this.updateUI();
                    this.generatePattern();
                }
            }

            updateUI() {
                document.getElementById('complexitySlider').value = this.settings.complexity;
                document.getElementById('scaleSlider').value = this.settings.scale;
                document.getElementById('speedSlider').value = this.settings.speed;
                document.getElementById('densitySlider').value = this.settings.density;
                
                document.getElementById('complexityValue').textContent = this.settings.complexity;
                document.getElementById('scaleValue').textContent = this.settings.scale + 'x';
                document.getElementById('speedValue').textContent = this.settings.speed + 'x';
                document.getElementById('densityValue').textContent = this.settings.density;
            }

            randomizeSettings() {
                this.settings.complexity = Math.floor(Math.random() * 10) + 1;
                this.settings.scale = Math.random() * 2.5 + 0.5;
                this.settings.speed = Math.random() * 2.5 + 0.1;
                this.settings.density = Math.floor(Math.random() * 400) + 50;
                
                this.updateUI();
            }

            toggleAnimation() {
                this.isAnimating = !this.isAnimating;
                const btn = document.getElementById('playPauseBtn');
                btn.innerHTML = this.isAnimating ? 
                    '<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' :
                    '<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1.586a1 1 0 01.707.293l2.414 2.414a1 1 0 00.707.293H15M9 10V9a2 2 0 012-2h2a2 2 0 012 2v1M9 10v5a2 2 0 002 2h2a2 2 0 002-2v-5"></path></svg>';
            }

            exportWallpaper() {
                if (this.p5Instance) {
                    // Stop animation temporarily
                    const wasAnimating = this.isAnimating;
                    this.isAnimating = false;
                    
                    // Render one frame
                    this.p5Instance.redraw();
                    
                    // Export as image
                    const link = document.createElement('a');
                    link.download = `generated_wallpaper_${Date.now()}.png`;
                    link.href = this.canvas.elt.toDataURL();
                    link.click();
                    
                    // Resume animation if it was running
                    if (wasAnimating) {
                        this.isAnimating = true;
                    }
                    
                    this.showNotification('Wallpaper exported successfully!');
                }
            }

            resetToDefaults() {
                this.settings = {
                    color: '#9caf88',
                    colorVariation: 50,
                    complexity: 5,
                    scale: 1.0,
                    speed: 1.0,
                    density: 100
                };
                
                this.updateUI();
            }

            toggleFullscreen() {
                const canvas = document.getElementById('editorCanvas');
                if (!document.fullscreenElement) {
                    canvas.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }

            showNotification(message) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new WallpaperEditor();
        });
    </script>
</body>
</html>